##  系统数据库设计

### 系统模块划分

主要就是一张功能图

### 数据库关系分析

根据上述的需求调研，可以将数据库的关系抽象为如下描述：

一个住户可以预定多个房间（产生多个订单）。一个订单只属于一个住户。住户可以对每个房间内的多个智能家居进行控制。一个酒店管理人员可以管理多个订单，对订单信息进行修改，确认每个订单的入住日期和结账离开日期。一个订单也可以被多个管理人员管理。一个房间对应多条开门记录，一条开门记录只对应一个房间。一个管理人员可以查看多个房间的开门记录。一条开门记录可以被多个管理员查看。一个房间内置多个智能家居。一个智能家居只属于一个房间。

### 数据库逻辑结构设计

数据库的关系模型根据数据模型来确定,即将关系模型转化为SL- Server数据库系统所支持 的实际数据模型,得到数据库的逻辑结构。在数据库的关系模型及系统处理过程中的数据的结构 的基础上,获得系统数据库表以及表之间的关系。在本系统中,以下是系统中几个主要的数据依赖和数据库表结构。

逻辑依赖.....

### 数据库物理结构设计

本系统依据上述的关系模型建立了八张关系表，它们的表名以及对应的名称如表2-1所示：

|        表名         |      备注      |
| :-----------------: | :------------: |
|        user         |   用户信息表   |
|        admin        |  管理员账号表  |
|      face_info      |   人脸信息表   |
|        order        |   订单信息表   |
|        room         |   房间信息表   |
|  air_conditioning   | 智能空调信息表 |
|        light        |  智能灯信息表  |
| door_opening_record | 开门记录信息表 |

#### 数据库住户信息表 (user)

用户信息表主要用于存储用户的信息，如姓名，性别等。通过该表可以操作每一个住户的信息。在数据表中id（用户编号）为主码。 wecharid为微信用户的唯一标志代号可用于区分用户的身份。该表如表2-2所示：

| 字段名   |   数据类型   | 是否为主键 | 是否为外键 |       检查规则       |             备注             |
| -------- | :----------: | :--------: | :--------: | :------------------: | :--------------------------: |
| wecharid | VARCHAR( 50) |     是     |     否     |   NOT NULL;UNIQUE    | 微信id，微信用户的唯一标识； |
| name     | VARCHAR(10)  |     否     |     否     |          无          |             姓名             |
| sex      |   CHAR(4)    |     否     |     否     | sex='男' or sex='女' |             性别             |
| id_card  | VARCHAR(50)  |     否     |     否     |        UNIQUE        |           身份证号           |
| phone    | VARCHAR(20)  |     否     |     否     |        UNIQUE        |           电话号码           |
| level    |     INT      |     否     |     否     |       NOT NULL       | 用户等级, 有1，2，3三个等级  |

#### 数据库管理员信息表 (admin)

管理员信息表主要用于储存管理员的账号和密码。该表如表2-3所示：

|  字段名  |   数据类型   | 是否为主键 | 是否为外键 | 检查规则 |            备注            |
| :------: | :----------: | :--------: | :--------: | :------: | :------------------------: |
|    id    |     INT      |     是     |     否     |    无    |          主键自增          |
| username | VARCHAR(10)  |     否     |     否     | NOT NULL |            账号            |
| password | VARCHAR(10)  |     否     |     否     | NOT NULL |            密码            |
|  token   | VARCHAR( 10) |     否     |     是     | NOT NULL | 用作身份验证，用户表的主键 |

数据表创建语句： ....

#### 数据库人脸信息表 (face_info)

|  字段名  |   数据类型   | 是否为主键 | 是否为外键 | 检查规则 |            备注            |
| :------: | :----------: | :--------: | :--------: | :------: | :------------------------: |
| wecharid | VARCHAR( 10) |     是     |     否     | NOT NULL | 微信id，微信用户的唯一标识 |
| face_id  | VARCHAR(10)  |     否     |     否     | NOT NULL | 人脸算法生成的唯一人脸标志 |

#### 数据库订单信息表 (order)

订单信息表主要用于保存用户的订单信息，如应付金额，入住日期等。在设计上用户和订单是一对多的关系，订单与房间是1对1的关系。在表中订单编号为主键。同时该表参照resident表的wecharid作为外键和room表的房间id作为外键，该表如表2-5所示：

|  字段名  |   数据类型   | 是否为主键 | 是否为外键 |    检查规则     |            备注            |
| :------: | :----------: | :--------: | :--------: | :-------------: | :------------------------: |
|    id    |     INT      |     是     |     否     | NOT NULL;UNIQUE |     订单编号，主键自增     |
|  pmoney  |     INT      |     否     |     否     |    NOT NULL     |        订单应付金额        |
|   scid   |   DATETIME   |     否     |     否     |    NOT NULL     |        预定入住日期        |
|   sgo    |   DATETIME   |     否     |     否     |    NOT NULL     |        预计离开日期        |
|   cid    |   DATETIME   |     否     |     否     |       无        |        实际入住日期        |
|    go    |   DATETIME   |     否     |     否     |       无        |        结账离开日期        |
| wecharid | VARCHAR( 50) |     否     |     是     |       无        | 微信id，微信用户的唯一标识 |
| room_id  |     INT      |     否     |     是     |       无        |          房间编号          |

#### 数据库房间信息表 (room)

房间信息表主要包括了房间的基本信息，如房间类型，房间编号等。其中还包括房间温度、房间湿度等状态信息。状态信息在设计上是由房间内传感器进行动态更新。房间与智慧家居是一对多的关系，与订单是1对1的关系。该表如表2-6所示：

|   字段名    |  数据类型   | 是否为主键 | 是否为外键 |    检查规则     |                            备注                            |
| :---------: | :---------: | :--------: | :--------: | :-------------: | :--------------------------------------------------------: |
|     id      |     INT     |     是     |     否     | NOT NULL;UNIQUE |                     房间编号，主键自增                     |
|    rtype    | VARCHAR(50) |     否     |     否     |    NOT NULL     |                          房间类型                          |
|   bedtype   | VARCHAR(50) |     否     |     否     |    NOT NULL     |                          房间床型                          |
|   maxnum    |     INT     |     否     |     否     |    NOT NULL     |                      房间居住人数上限                      |
|    area     | VARCHAR(50) |     否     |     否     |    NOT NULL     |                          房间面积                          |
|    rwin     |   tinyint   |     否     |     否     |    NOT NULL     |             房间是否有窗：1表示有窗，0表示没床             |
|    rlock    |     INT     |     否     |     否     |    NOT NULL     | 房间锁的状态：0表示已锁，1表示没锁，2表示锁损坏，3表示没锁 |
|    money    |     INT     |     否     |     否     |    NOT NULL     |                        房间金额/日                         |
| temperature |    FLOAT    |     否     |     否     |    NOT NULL     |                        房间当前温度                        |
|  humidity   |    FLOAT    |     否     |     否     |    NOT NULL     |                        房间当前湿度                        |

#### 数据库智能空调信息表 (air_conditioning)

智能空调信息表中包括了各个房间空调的数值和状态。同时该表使用room表的房间编号作为外键约束。 空调与房间为1对1的关系，一个房间只有一个空调。该表如表2-7所示：

| 字段名  | 数据类型 | 是否为主键 | 是否为外键 |       检查规则       |          备注          |
| :-----: | :------: | :--------: | :--------: | :------------------: | :--------------------: |
|   id    |   INT    |     是     |     否     |   NOT NULL;UNIQUE    |   空调编号，主键自增   |
| status  |   INT    |     否     |     否     | status=0 or status=1 |  0表示关闭，1表示开启  |
| air_tmp |  FLOAT   |     否     |     否     |       NOT NULL       |      空调当前温度      |
| room_id |   INT    |     否     |     是     |          无          | 房间编号，房间表的主键 |

#### 数据库智能灯信息表 (light)

智能灯信息表中包括了各个房间灯的数值和状态。同时该表使用room表的房间编号作为外键约束。 灯与房间为多对1的关系，一个房间可以有多个智能灯。该表如表2-8所示：

|   字段名    | 数据类型 | 是否为主键 | 是否为外键 |       检查规则       |          备注          |
| :---------: | :------: | :--------: | :--------: | :------------------: | :--------------------: |
|     id      |   INT    |     是     |     否     |   NOT NULL;UNIQUE    |    灯编号，主键自增    |
|   status    |   INT    |     否     |     否     | status=0 or status=1 |  0表示关闭，1表示开启  |
| light_value |  FLOAT   |     否     |     否     |       NOT NULL       |      灯当前的亮度      |
|   room_id   |   INT    |     否     |     是     |          无          | 房间编号，房间表的主键 |

#### 数据库开门记录信息表 (door_opening_record)

开门记录信息表记录了每个房间使用小程序打开门的时间和开门人的wecharid。一个房间可以对应多条开门记录。该表如表2-9所示

|  字段名   |   数据类型   | 是否为主键 | 是否为外键 |    检查规则     |            备注            |
| :-------: | :----------: | :--------: | :--------: | :-------------: | :------------------------: |
|    id     |     INT      |     是     |     否     | NOT NULL;UNIQUE |     记录编号，主键自增     |
| wecharid  | VARCHAR( 10) |     否     |     否     |    NOT NULL     | 微信id，微信用户的唯一标识 |
| open_time |   DATETIME   |     否     |     否     |    NOT NULL     |         开门的时间         |
|  room_id  |     INT      |     否     |     否     |    NOT NULL     |          房间编号          |











